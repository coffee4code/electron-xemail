var angular=require("angular"),remote=require("electron").remote,path=require("path");angular.module("app.controller",[]).controller("appCtrl",["$rootScope","$scope","$mdColors",function(a,b,c){}]).controller("menuCtrl",["$scope","$state","$mdDialog",function(a,b,c){function d(){b.go("app.home")}function e(){b.go("app.sheet.open")}function f(){var b=c.confirm().title("关闭").textContent("确定退出应用程序？").ariaLabel("退出程序").targetEvent(event).ok("确定退出").cancel("取消");c.show(b).then(function(){a.window.close()},function(){return!1})}function g(){a.window.isMaximized()?a.window.unmaximize():a.window.maximize()}function h(){a.window.minimize()}function i(){a.window.webContents.openDevTools()}function j(a){b.go("app.setting."+a)}function k(a){m("help",a)}function l(a){m("about",a)}function m(a,b){c.show({controller:n,templateUrl:"tmpls/dialogs/dialog."+a+".html",parent:angular.element(document.body),targetEvent:b,clickOutsideToClose:!0,fullscreen:!1})}function n(a,b){a.hide=function(){b.hide()}}a.window=remote.getCurrentWindow(),a.onHome=d,a.onOpen=e,a.onExit=f,a.onMaximum=g,a.onDevTool=i,a.onMinimize=h,a.onSetting=j,a.onHelp=k,a.onAbout=l}]).controller("contentCtrl",["$scope",function(a){}]).controller("homeCtrl",["$scope",function(a){}]).controller("sheetCtrl",["$scope",function(a){var b=new Date;a.current={year:b.getFullYear(),month:b.getMonth()+1,progress:0,filePath:"",fileName:"",sheetName:""}}]).controller("sheetOpenCtrl",["$scope","$state","$filter","$mdToast",function(a,b,c,d){function e(b){var e=!1;return b&&b.path&&(e=c("filetype")(b.path,a.openner.fileType.join(","))),e?(a.openner.status=1,void(a.openner.file=b)):(a.openner.status=-1,d.show(d.simple().textContent("不支持的文件类型!").position("bottom center")),!1)}function f(){a.openner.file&&(a.current.filePath=a.openner.file.path,b.go("app.sheet.load"))}a.current.progress=0,a.openner={status:0,fileType:["xls","xlsx"],file:null},a.onFileChange=e,a.onStart=f}]).controller("sheetLoadCtrl",["$scope","$state","xlsxService",function(a,b,c){function d(){b.go("app.sheet.list")}a.current.progress=25,a.current.fileName=path.basename(a.current.filePath),a.sheetNames=c.load(a.current.filePath),a.current.sheetName=a.sheetNames[0],a.onNext=d}]).controller("sheetListCtrl",["$scope","$mdDialog","xlsxService","templateDetail",function(a,b,c,d){function e(){a.$watch("keyword",function(b){a.rowList.map(function(a){a.show=i(a,b)})})}function f(){for(var b=0;b<a.rowList.length;b++)a.selected.push(a.rowList[b])}function g(c){b.show({templateUrl:"tmpls/dialogs/dialog.template.detail.html",parent:angular.element(document.body),targetEvent:c,clickOutsideToClose:!0,fullscreen:!1,locals:{templateDetail:a.templateDetail},controller:["$scope","$mdDialog","templateDetail",function(a,b,c){a.templateDetail=c,a.onClose=function(){b.hide()}}]})}function h(){console.info(a.selected)}function i(a,b){if(!b)return!0;for(var c in a)if(String(a[c]).indexOf(b)>-1)return!0;return!1}a.current.progress=50,a.templateDetail=d,a.rowList=c.list(a.current.sheetName),a.selected=[],a.keyword="",a.onNext=h,a.onDetailDialog=g,e(),f()}]).controller("settingCtrl",["$scope",function(a){}]).controller("settingUserCtrl",["$scope","$mdToast","settingService","setting",function(a,b,c,d){function e(){c.setItemBatch({sender_email:a.setting.sender_email,sender_password:a.setting.sender_password,smtp_host:a.setting.smtp_host,smtp_port:a.setting.smtp_port}),b.show(b.simple().textContent("保存成功！").position("left bottom").hideDelay(3e3))}a.setting=d,a.current={status:1},a.onSave=e}]).controller("settingTemplateCtrl",["$scope","$mdToast","templateService","template","templateDetail",function(a,b,c,d,e){function f(){c.setAll(d),b.show(b.simple().textContent("保存成功！").position("left bottom").hideDelay(3e3))}a.template=d,a.templateDetail=e,a.current={status:1},a.onSave=f}]);var angular=require("angular");angular.module("app.directive",[]).directive("myDropZone",[function(){return{restrict:"A",scope:{onFileDrop:"="},link:function(a,b){b.bind("drop",function(b){b.stopPropagation(),b.preventDefault();var c=null;b&&b.dataTransfer&&b.dataTransfer.files&&b.dataTransfer.files.length&&(c=b.dataTransfer.files[0]),a.onFileDrop(c)}),b.bind("dragover",function(a){a.preventDefault(),$(this).addClass("drop-active")}),b.bind("dragleave",function(a){a.preventDefault(),$(this).removeClass("drop-active")}),$(window).bind("drop dragover",function(a){a.preventDefault()})}}}]).directive("myFilePicker",[function(){return{restrict:"EA",scope:{fileType:"=",myOnChange:"="},template:'<div>   <div class="drop-area" id="file-drop-area"  layout="column" flex layout-align="center center" my-drop-zone on-file-drop="onFileDrop">      <div flex></div>      <div class="drop-area-icon" layout="column" layout-align="center bottom">          <ng-md-icon icon="cloud_download" size="100" style="fill:{{$root.mdPrimaryColor}};"></ng-md-icon>      </div>      <div class="drop-area-tip" layout="column" layout-align="center center" ng-if="!!current.filePath" ng-bind="current.filePath"></div>      <div class="drop-area-tip" layout="column" layout-align="center center" ng-if="!current.filePath">点击选择xls文件或将文件拖放到这里</div>      <div flex></div>   </div>   <input id="file-input" type="file" my-on-change="onFileChange" style="display: none;"></div>',replace:!0,link:function(a,b,c){function d(b){a.current.filePath=b.path,a.$apply(function(){a.myOnChange(b)})}function e(){g.bind("change",function(b){a.$apply(function(){var c=null;b.target&&b.target.files&&b.target.files.length&&(c=b.target.files[0]),a.current.filePath=c.path,a.myOnChange(c)})}),h.bind("click",function(a){g.trigger("click")})}a.current={filePath:""},a.onFileDrop=d;var f=$(b),g=f.find("#file-input"),h=f.find("#file-drop-area");e()}}}]).directive("myInputUppercase",["$filter",function(a){return{restrict:"EA",require:"ngModel",link:function(a,b,c,d){function e(a){return(a||"").toUpperCase()}d.$parsers.push(e),d.$formatters.push(e)}}}]);var angular=require("angular"),ngRouter=require("angular-ui-router");angular.module("app.router",[ngRouter]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){c.hashPrefix("!"),b.otherwise("/home"),a.state("app",{url:"","abstract":!0,views:{menu:{templateUrl:"tmpls/menu.html",controller:"menuCtrl"},content:{templateUrl:"tmpls/content.html",controller:"contentCtrl"}}}).state("app.home",{url:"/home",views:{main:{templateUrl:"tmpls/pages/home.html",controller:"homeCtrl"}}}).state("app.sheet",{url:"/sheet","abstract":!0,views:{main:{templateUrl:"tmpls/pages/sheet/sheet.html",controller:"sheetCtrl"}}}).state("app.sheet.open",{url:"/open",views:{step:{templateUrl:"tmpls/pages/sheet/open.html",controller:"sheetOpenCtrl"}}}).state("app.sheet.load",{url:"/load",views:{step:{templateUrl:"tmpls/pages/sheet/load.html",controller:"sheetLoadCtrl"}}}).state("app.sheet.list",{url:"/list",views:{step:{templateUrl:"tmpls/pages/sheet/list.html",controller:"sheetListCtrl",resolve:{templateDetail:["templateService",function(a){return a.getDetail()}]}}}}).state("app.setting",{url:"/setting",absolute:!0,views:{main:{templateUrl:"tmpls/pages/setting/setting.html",controller:"settingCtrl"}}}).state("app.setting.user",{url:"/user",views:{list:{templateUrl:"tmpls/pages/setting/user.html",controller:"settingUserCtrl",resolve:{setting:["settingService",function(a){return a.getAll()}]}}}}).state("app.setting.template",{url:"/template",views:{list:{templateUrl:"tmpls/pages/setting/template.html",controller:"settingTemplateCtrl",resolve:{template:["templateService",function(a){return a.getAll()}],templateDetail:["templateService",function(a){return a.getDetail()}]}}}})}]);var angular=require("angular"),XLSX=require("xlsx");angular.module("app.service",[]).service("xlsxService",["$filter","templateService",function(a,b){function c(a){return g=XLSX.readFile(a),g.SheetNames}function d(a){var c=[],d=b.getAll();return h=g.Sheets[a],c=e(h,d)}function e(a,b){var c=[];if(a["!ref"])for(var d=a["!ref"].match(/^([A-Z]+?)([\d]+?):([A-Z]+?)([\d]+?)$/),e=d[4],g=0;g<e;g++)if(f(a,g,b.employee_email)){var h={};for(var i in b){var j=a[b[i]+""+g];j&&j.v?(h[i]=j.v,"wage_everyday"==i&&(h[i]=Number(j.v).toFixed(2))):h[i]="-"}c.push(h)}return c}function f(b,c,d){var e=b[d+""+c];return!!(e&&e.v&&a("isemail")(e.v))}var g=null,h=null;return{load:c,list:d}}]).service("templateService",["config","databaseService",function(a,b){function c(){var a="DROP TABLE IF EXISTS "+k+"; CREATE TABLE "+k+" (id INTEGER PRIMARY KEY AUTOINCREMENT, cell STRING, cellColumn STRING);",c=[];for(var d in j)c.push("INSERT INTO "+k+" VALUES (NULL, '"+d+"','"+j[d]+"')");b.create(k,a+c.join(";"))}function d(){var a={},c=b.table(k);return a=i(c)}function e(a){var c=[];for(var d in a)c.push("UPDATE "+k+' SET cellColumn="'+a[d]+'" WHERE cell="'+d+'"');return c=c.join(";"),b.execute(k,c)}function f(){var a={},b=d();for(var c in b)a[c]={value:b[c],show:g(c),label:h(c)};return a}function g(a){var b=["employee_department","employee_workday","wage_everyday","deductions_other","deductions_social_security","deductions_provident_fund","deductions_personal_tax"];return!(b.indexOf(a)>-1)}function h(a){switch(a){case"employee_email":return"员工邮箱";case"employee_name":return"员工姓名";case"employee_department":return"员工部门";case"employee_workday":return"满勤天数";case"employee_attendance":return"实际出勤";case"wage_base":return"基本工资";case"wage_allowance":return"岗位津贴";case"wage_reward":return"员工奖金";case"wage_everyday":return"日工资";case"wage_total":return"应发合计";case"deductions_absence":return"缺勤扣款";case"deductions_sick_leave":return"病事假扣款";case"deductions_other":return"其他扣款";case"deductions_social_security":return"社保个人部分";case"deductions_provident_fund":return"公积金个人部分";case"deductions_personal_tax":return"个税";case"final_amount":return"实发工资"}}function i(a){var b={};if(a&&a.length&&(a=a[0].values),a&&a.length)for(var c in a)b[a[c][1]]=a[c][2];return b}var j=a.get().TEMPLATES,k="template";return{init:c,getAll:d,setAll:e,getDetail:f}}]).service("settingService",["config","databaseService",function(a,b){function c(){var a="DROP TABLE IF EXISTS "+k+"; CREATE TABLE "+k+" (id INTEGER PRIMARY KEY AUTOINCREMENT, itemKey STRING, itemValue STRING);",c=[];for(var d in j)c.push("INSERT INTO "+k+" VALUES (NULL, '"+d+"','"+j[d]+"')");b.create(k,a+c.join(";"))}function d(){var a={},c=b.table(k);return a=i(c)}function e(a){var c=null,d=b.filter(k,"SELECT * FROM "+k+" WHERE itemKey=:key;",{":key":a});return d&&(c={},c[d.itemKey]=d.itemValue),c}function f(a,c){return b.execute(k,"UPDATE "+k+' SET itemValue="'+c+'" WHERE itemKey="'+a+'";')}function g(a){var c=[];for(var d in a)c.push((c.length?" OR ":"")+' itemKey="'+a[d]+'" ');c=c.join(" "),c="SELECT * FROM "+k+" WHERE "+c;var e=b.execute(k,c),f=i(e);return f}function h(a){var c=[];for(var d in a)c.push("UPDATE "+k+' SET itemValue="'+a[d]+'" WHERE itemKey="'+d+'"');return c=c.join(";"),b.execute(k,c)}function i(a){var b={};if(a&&a.length&&(a=a[0].values),a&&a.length)for(var c in a)b[a[c][1]]=a[c][2];return b}var j=a.get().SETTINGS,k="setting";return{init:c,getAll:d,getItem:e,setItem:f,getItemBatch:g,setItemBatch:h}}]);var angular=require("angular");angular.module("app.config",[]).provider("config",[function(){function a(){return d}function b(a){d.SETTINGS=a}function c(a){d.TEMPLATES=a}var d={SETTINGS:{},TEMPLATES:{}};this.setSetting=b,this.setTemplate=c,this.$get=function(){return{get:a}}}]).config(["$mdThemingProvider",function(a){a.theme("default").primaryPalette("pink").accentPalette("pink")}]).config(["configProvider",function(a){var b={smtp_host:"smtp.qq.com",smtp_port:"465",sender_email:"1062893543@qq.com",sender_password:"anqckibffhrpbcef"},c={employee_email:"K",employee_name:"B",employee_department:"C",employee_workday:"R",employee_attendance:"T",wage_base:"L",wage_allowance:"M",wage_reward:"N",wage_everyday:"Q",wage_total:"O",deductions_absence:"U",deductions_sick_leave:"V",deductions_other:"W",deductions_social_security:"X",deductions_provident_fund:"Y",deductions_personal_tax:"Z",final_amount:"AC"};a.setSetting(b),a.setTemplate(c)}]);var angular=require("angular"),fs=require("fs"),SQL=require("sql.js"),path=require("path");angular.module("app.database",[]).service("databaseService",[function(){function a(a,b){if(!j||!j[a]){if(!e(a)){var c=new SQL.Database;return c.run(b),j[a]=c,h(a),!0}return!1}}function b(a,b,c){var d=null;if(g(a)&&f(a)){var e=j[a],h=e.prepare(b);d=h.getAsObject(c)}return d}function c(a,b){var c=null;if(g(a)&&f(a)){var d=j[a];c=d.exec(b),h(a)}return c}function d(a){var b=null;if(g(a)&&f(a)){var c=j[a];b=c.exec("SELECT * FROM "+a)}return b}function e(a){return fs.existsSync(i(a))}function f(a){return j&&j[a]&&j[a].db}function g(a){if(f(a))return!0;try{var b=fs.readFileSync(i(a));return j[a]=new SQL.Database(b),!0}catch(c){return!1}}function h(a){try{if(f(a)){var b=j[a],c=b["export"](),d=new Buffer(c);fs.writeFileSync(i(a),d)}}catch(e){}finally{return}}function i(a){return path.resolve(__dirname,"database",a)}var j=[];return{filter:b,execute:c,table:d,create:a}}]);var angular=require("angular");angular.module("app.filter",[]).filter("filetype",[function(){return function(a,b){b=b.split(",");var c=a.match(/\.([\w\W]+)/)[1];return b.indexOf(c)>-1}}]).filter("isemail",[function(){return function(a){return a&&/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i.test(a)}}]);var angular=require("angular"),angularAnimiate=require("angular-animate"),angularAria=require("angular-aria"),angularMaterial=require("angular-material"),angularMdIcons=require("angular-material-icons"),angularMdTable=require("angular-material-data-table"),app=angular.module("app",[angularAnimiate,angularAria,angularMaterial,angularMdIcons,angularMdTable,"app.router","app.directive","app.controller","app.database","app.config","app.service","app.filter"]);app.run(["$rootScope","$state","$mdColors","settingService","templateService",function(a,b,c,d,e){a.mdPrimaryColor=c.getThemeColor("pink"),d.init(),e.init()}]),app.bootstrap=function(){angular.bootstrap(window.document,["app"])},app.bootstrap();